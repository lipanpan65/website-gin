# Go Gin 开发环境 Dockerfile
FROM golang:1.25.0-alpine

# 设置维护者信息
LABEL maintainer="Website Development Team"
LABEL description="Go Gin Development Environment with Hot Reload"

# 设置工作目录
WORKDIR /app

# 安装必要的系统依赖和开发工具
RUN apk add --no-cache \
    git \
    gcc \
    musl-dev \
    make \
    curl \
    bash \
    ca-certificates \
    tzdata

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 设置Go环境变量
ENV GO111MODULE=on \
    GOPROXY=https://goproxy.cn,direct \
    GOSUMDB=sum.golang.org \
    CGO_ENABLED=1 \
    GO_ENV=dev

# 复制go.mod和go.sum文件
COPY go.mod go.sum ./

# 下载Go模块依赖
RUN go mod download && go mod verify

# 安装Air热重载工具
RUN go install github.com/air-verse/air@latest

# 安装Delve调试器
RUN go install -v github.com/go-delve/delve/cmd/dlv@latest

# 复制Air配置文件
COPY .air.toml ./

# 复制源代码
COPY . .

# 创建必要的目录
RUN mkdir -p tmp logs

# 设置文件权限
RUN chmod +x /go/bin/air /go/bin/dlv

# 暴露应用端口和调试端口
EXPOSE 9899 2345

# 复制启动脚本
COPY entrypoint.sh /app/entrypoint.sh

# 设置启动脚本权限
RUN chmod +x /app/entrypoint.sh

# 使用启动脚本作为入口点
ENTRYPOINT ["/app/entrypoint.sh"]

# 默认命令参数
CMD []